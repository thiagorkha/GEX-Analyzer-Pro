<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>GEX - Debug & Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test-box {
            background: #2d2d2d;
            border: 1px solid #444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #1177bb;
        }
        input {
            background: #3e3e42;
            color: #d4d4d4;
            border: 1px solid #555;
            padding: 8px;
            margin: 5px;
            border-radius: 3px;
        }
        #console {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 3px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warn { color: #ce9178; }
        .info { color: #6a9955; }
        h1 { color: #007acc; }
        h2 { color: #9cdcfe; font-size: 16px; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>üêõ GEX Analyzer - Debug Console</h1>

    <div class="test-box">
        <h2>Step 1: Check Initialization</h2>
        <button onclick="testInit()">Test Initialization</button>
        <button onclick="testElements()">Test DOM Elements</button>
        <button onclick="testEventListeners()">Test Event Listeners</button>
    </div>

    <div class="test-box">
        <h2>Step 2: Simulate Data Entry</h2>
        <input type="number" id="price" placeholder="Price (e.g., 100.50)" value="100.50">
        <input type="date" id="expiry">
        <button onclick="setTestData()">Set Test Data</button>
        <button onclick="loadTestOptions()">Load Test Options (Simulating Excel)</button>
    </div>

    <div class="test-box">
        <h2>Step 3: Simulate Analyze Click</h2>
        <button onclick="simulateAnalyzeClick()">üì§ Simulate Analyze Button Click</button>
        <button onclick="testAPI()">üì° Test API Call Directly</button>
    </div>

    <div class="test-box">
        <h2>üíæ Console Output</h2>
        <button onclick="clearConsole()">Clear Console</button>
        <button onclick="downloadConsole()">Download Log</button>
        <div id="console"></div>
    </div>

    <script>
        // Hijack console
        const consoleDiv = document.getElementById('console');
        let consoleLog = '';

        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog(...args);
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
            consoleLog += `<span class="info">LOG:</span> ${msg}\n`;
            updateConsoleView();
        };

        console.error = function(...args) {
            originalError(...args);
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
            consoleLog += `<span class="error">ERROR:</span> ${msg}\n`;
            updateConsoleView();
        };

        console.warn = function(...args) {
            originalWarn(...args);
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
            consoleLog += `<span class="warn">WARN:</span> ${msg}\n`;
            updateConsoleView();
        };

        function updateConsoleView() {
            consoleDiv.innerHTML = consoleLog;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function clearConsole() {
            consoleLog = '';
            consoleDiv.innerHTML = '';
        }

        function downloadConsole() {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(consoleLog));
            element.setAttribute('download', 'gex-debug-log.txt');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        console.log('üîß Debug Console Loaded');

        function testInit() {
            console.log('\n=== Testing Initialization ===');
            console.log('window.app exists:', !!window.app);
            console.log('window.excelParser exists:', !!window.excelParser);
            console.log('window.uploadedOptions exists:', !!window.uploadedOptions);
            
            if (window.app) {
                console.log('app.analyzeBtn:', !!window.app.analyzeBtn);
                console.log('app.priceInput:', !!window.app.priceInput);
                console.log('app.expirationInput:', !!window.app.expirationInput);
            }
        }

        function testElements() {
            console.log('\n=== Testing DOM Elements ===');
            const elements = [
                'current-price', 'expiration-date', 'file-input', 'file-upload-area',
                'analyze-btn', 'load-example-btn', 'debug-btn', 'file-status',
                'error-message', 'success-message', 'info-message', 'loading'
            ];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                console.log(`  ${id}: ${el ? '‚úÖ Found' : '‚ùå NOT FOUND'}`);
            });
        }

        function testEventListeners() {
            console.log('\n=== Testing Event Listeners ===');
            const analyzeBtn = document.getElementById('analyze-btn');
            
            if (analyzeBtn) {
                console.log('analyze-btn found, attempting click...');
                analyzeBtn.click();
                console.log('analyze-btn clicked');
            } else {
                console.error('analyze-btn NOT found!');
            }
        }

        function setTestData() {
            console.log('\n=== Setting Test Data ===');
            const priceInput = document.getElementById('current-price');
            const expiryInput = document.getElementById('expiration-date');
            
            if (priceInput) {
                priceInput.value = document.getElementById('price').value;
                console.log('Price set to:', priceInput.value);
            }
            
            if (expiryInput) {
                expiryInput.value = document.getElementById('expiry').value;
                console.log('Expiry set to:', expiryInput.value);
            }
        }

        function loadTestOptions() {
            console.log('\n=== Loading Test Options ===');
            const testOptions = [
                { ticker: 'SPY', tipo: 'CALL', strike: 100.0, gamma: 0.28, oi: 12000 },
                { ticker: 'SPY', tipo: 'PUT', strike: 100.0, gamma: 0.15, oi: 4000 },
                { ticker: 'SPY', tipo: 'CALL', strike: 102.0, gamma: 0.20, oi: 8000 },
                { ticker: 'SPY', tipo: 'PUT', strike: 98.0, gamma: 0.18, oi: 6000 }
            ];
            
            window.uploadedOptions = testOptions;
            document.getElementById('file-status').textContent = `‚úÖ ${testOptions.length} op√ß√µes carregadas (teste)`;
            document.getElementById('analyze-btn').disabled = false;
            
            console.log('Test options loaded:', testOptions);
            console.log('window.uploadedOptions:', window.uploadedOptions);
        }

        function simulateAnalyzeClick() {
            console.log('\n=== Simulating Analyze Click ===');
            const btn = document.getElementById('analyze-btn');
            if (btn) {
                console.log('Found analyze button, clicking...');
                btn.click();
            } else {
                console.error('Analyze button not found!');
            }
        }

        async function testAPI() {
            console.log('\n=== Testing API Directly ===');
            try {
                const payload = {
                    current_price: 100.0,
                    expiration_date: new Date().toISOString().split('T')[0],
                    options: [
                        { ticker: 'SPY', tipo: 'CALL', strike: 100.0, gamma: 0.28, oi: 12000 },
                        { ticker: 'SPY', tipo: 'PUT', strike: 100.0, gamma: 0.15, oi: 4000 }
                    ]
                };
                
                console.log('Sending payload:', payload);
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
            } catch (error) {
                console.error('API Error:', error);
            }
        }

        // Initial tests
        window.addEventListener('load', () => {
            console.log('\n‚úÖ Page loaded, running initial tests...');
            setTimeout(() => {
                testInit();
            }, 100);
        });
    </script>

    <!-- Load app scripts -->
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.26.0/dist/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="js/excel-parser.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
